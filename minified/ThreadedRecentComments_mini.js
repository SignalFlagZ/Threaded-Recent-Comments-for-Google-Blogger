//	Threaded Recent Comments JQuery Plugin Ver.2.30
//	Google Blogger用 最近のコメント表示 
//						Copyright 2014-2018 Signal Flag "Z"
(function (a) { a.fn.ThreadedRecentComments = function (l) { var k = "2.30"; var f = "Threaded Recent Comments Ver." + k + " by <a href='https://signal-flag-z.blogspot.com/'>Signal Flag Z</a>"; if (!l.yourURL) { this.html("Set yourURL."); return } var g = { itemCount: 5, daysNew: 7, isMobile: false, feedURL: l.yourURL + "feeds/comments/default", timeout: 15000 }; l = jQuery.extend(g, l); var b = jQuery.extend(l, { ajaxData: { alt: "json-in-script", "max-results": l.itemCount } }); if (b.itemCount > 150) { b.itemCount = 150 } var i = {}; i.jQThis = this; return this.each(function () { c(i) }); function c(m) { jQuery.ajax({ timeout: b.timeout, url: b.feedURL, data: b.ajaxData, dataType: "jsonp" }).done(function (o, p, n) { m.json = o; m.CommList = e(m); m.html = j(m) }).fail(function (o, q, p) { var n = ""; switch (q) { case "parsererror": n = "Requested JSON parse failed."; break; case "timeout": n = "Time out error."; break; case "abort": n = "Request aborted."; break; default: n = "Uncaught Error."; break }m.html = n }).always(function (n, o) { jQuery(m.jQThis).html(m.html); d() }) } function d() { if (b.cssTRC != void (0)) { jQuery(".ThreadedRecentComments").css(b.cssTRC) } if (b.cssPostTitle != void (0)) { jQuery(".ThreadedRecentComments  .postTitle").css(b.cssPostTitle) } if (b.cssCommentThread != void (0)) { jQuery(".ThreadedRecentComments  .commentThread").css(b.cssCommentThread) } if (b.cssParentPostedby != void (0)) { jQuery(".ThreadedRecentComments .parent .postedby").css(b.cssParentPostedby) } if (b.cssChildPostedby != void (0)) { jQuery(".ThreadedRecentComments .child .postedby").css(b.cssChildPostedby) } if (b.cssParentCommentBaloon != void (0)) { jQuery(".ThreadedRecentComments .parent  .commentBaloon").css(b.cssParentCommentBaloon) } if (b.cssChildCommentBaloon != void (0)) { jQuery(".ThreadedRecentComments .child .CommentBaloon").css(b.cssChildCommentBaloon) } } function e(n) { var m = {}; jQuery(n.json.feed.entry).each(function (t) { var o = ""; var s = false; var v = this.id.$t.match(/[0-9]*$/); if (v != null) { v = v[0] } else { v = "" } if ("thr$in-reply-to" in this) { var w = this["thr$in-reply-to"].ref.match(/[0-9]*$/); w = w[0]; if (m[w] == void (0)) { m[w] = {}; m[w]["href"] = this["thr$in-reply-to"].href } if (m[w][v] == void (0)) { m[w][v] = {}; if (this["thr$in-reply-to"].href.indexOf("blogspot.com/p/") != -1) { s = true } var u = b.yourURL + "feeds/posts/default/" + w; if (s) { u = b.yourURL + "feeds/pages/default/" + w } jQuery.ajax({ data: b.ajaxData, timeout: b.timeout, url: u, dataType: "jsonp" }).done(function (y, z, x) { m[w]["title"] = y.entry.title.$t }).fail(function (y, A, z) { var x = ""; switch (A) { case "parsererror": x = "Requested JSON parse failed."; break; case "timeout": x = "Time out error."; break; case "abort": x = "Request aborted."; break; default: x = "Uncaught Error."; break }m[w]["title"] = "Unknown title. " + x }).always(function (x, y) { jQuery(n.jQThis).find("#" + w).html(m[w]["title"]) }) } } if ("thr$in-reply-to" in this) { m[w]["reply-to"] = this["thr$in-reply-to"].href } else { var w = "NotExist"; m[w] = {}; m[w][v] = {}; m[w]["reply-to"] = "" } m[w][v]["ID"] = v; m[w][v]["href"] = ""; m[w][v]["parent"] = ""; m[w][v]["title"] = this.title.$t; m[w][v]["author"] = {}; m[w][v]["author"]["name"] = this.author[0].name.$t; if (this.author[0].uri != void (0)) { m[w][v]["author"]["uri"] = this.author[0].uri.$t } m[w][v]["author"]["image"] = this.author[0].gd$image.src; o = this.updated.$t.match(/(\d+)-(\d+)-(\d+)T(\d+):(\d+):(\d+)\.(\d{3})([+-])(\d+):(\d+)/); m[w][v]["Date"] = new Date(o[1], o[2] - 1, o[3], o[4], o[5], o[6], o[7]); for (var q = 0; q < this.link.length; ++q) { switch (this.link[q].rel) { case "alternate": var p = this.link[q].href; m[w][v]["href"] = p; break; case "related": var r = this.link[q].href.match(/[0-9]*$/); m[w][v]["parent"] = r[0]; if (m[w][r[0]] == void (0)) { m[w][r[0]] = {}; m[w][r[0]]["ID"] = r[0]; m[w][r[0]]["parent"] = ""; m[w][r[0]]["href"] = ""; m[w][r[0]]["title"] = "&hellip;"; m[w][r[0]]["Date"] = ""; m[w][r[0]]["author"] = {}; m[w][r[0]]["author"]["name"] = "&hellip;"; m[w][r[0]]["author"]["uri"] = ""; m[w][r[0]]["author"]["image"] = "" } if (m[w][r[0]]["children"] == void (0)) { m[w][r[0]]["children"] = {} } m[w][r[0]]["children"][v] = v; break } } }); return m } function j(y) { var v = "&ldquo;"; var s = "&rdquo;"; var p = document.createDocumentFragment(); var u = document.createElement("div"); u.setAttribute("class", "ThreadedRecentComments"); var r = p.appendChild(u); u = document.createElement("div"); u.setAttribute("class", "threadList"); var q = r.appendChild(u); u = document.createElement("div"); u.setAttribute("class", "powered"); u.innerHTML = f; r.appendChild(u); for (var C in y.CommList) { if (y.isMobile) { y.CommList[C]["reply-to"] += "?m=1" } u = document.createElement("div"); u.setAttribute("class", "postTitle"); var o = q.appendChild(u); u = document.createElement("div"); u.setAttribute("class", "postTitleText"); var n = o.appendChild(u); u = document.createElement("a"); u.setAttribute("href", y.CommList[C]["reply-to"]); var m = n.appendChild(u); u = document.createElement("span"); u.setAttribute("id", C); u.textContent = "Loading... or Maybe Deleted."; var D = m.appendChild(u); for (var B in y.CommList[C]) { if (y.CommList[C][B]["parent"] == "") { u = document.createElement("div"); u.setAttribute("class", "commentThread"); n = o.appendChild(u); u = document.createElement("div"); u.setAttribute("class", "parent clearfloat"); m = n.appendChild(u); u = h(y, C, B); D = m.appendChild(u); var t = y.CommList[C][B]["author"]["name"]; if (y.CommList[C][B]["children"] !== void (0)) { var w = document.createDocumentFragment(); if (t == "&hellip;") { var z = Object.keys(y.CommList[C][B]["children"]).length; var x = Object.keys(y.CommList[C][B]["children"])[z - 1]; t = y.CommList[C][x]["author"]["name"] } for (var A in y.CommList[C][B]["children"]) { u = document.createElement("div"); if (y.CommList[C][A]["author"]["name"] == t) { u.setAttribute("class", "parent clearfloat") } else { u.setAttribute("class", "child clearfloat") } m = w.insertBefore(u, w.firstChild); u = h(y, C, A); D = m.appendChild(u) } m = n.appendChild(w) } } } } return p } function h(p, q, n) { var s = document.createDocumentFragment(); var u = document.createElement("span"); u.setAttribute("class", "comment"); var r = s.appendChild(u); if (Date.now() - p.CommList[q][n]["Date"] < 86400000 * b.daysNew) { u = document.createElement("span"); u.setAttribute("class", "new"); u.textContent = "New!"; var o = r.appendChild(u) } u = document.createElement("span"); u.setAttribute("class", "commentBaloon"); var o = r.appendChild(u); u = document.createElement("span"); u.setAttribute("class", "commentTxt"); if (p.CommList[q][n]["href"] == "") { u.innerHTML = p.CommList[q][n]["title"] } else { if (p.isMobile) { p.CommList[q][n]["href"] = p.CommList[q][n]["href"].replace(/showComment=/, "m=1&showComment=") } var t = document.createElement("a"); t.setAttribute("href", p.CommList[q][n]["href"]); t.innerHTML = p.CommList[q][n]["title"]; u.appendChild(t) } var m = o.appendChild(u); u = document.createElement("span"); u.setAttribute("class", "postedby"); o = r.appendChild(u); u = document.createElement("img"); u.setAttribute("src", p.CommList[q][n]["author"]["image"]); o.appendChild(u); u = document.createElement("span"); u.setAttribute("class", "auth"); u.innerHTML = "[" + p.CommList[q][n]["author"]["name"] + "] "; o.appendChild(u); u = document.createElement("span"); u.setAttribute("class", "date"); u.textContent = p.CommList[q][n]["Date"].toLocaleString(); o.appendChild(u); return s } } })(jQuery);